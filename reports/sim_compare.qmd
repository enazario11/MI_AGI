---
title: "MI - AGI: Simulated data"
author: "Emily Nazario"
date: "`r Sys.Date()`"
format:
 html: 
  embed-resources: true
editor: visual
toc: TRUE
toc-title: "On this page"
theme: yeti
fontcolor: "#134f5c"
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
#| echo: false
#| warning: false
#| label: libraries

library(tidyverse)
library(tidyquant)
library(terra)
library(sf)
library(here)
library(rnaturalearth)
library(rnaturalearthdata)
library(wesanderson)
library(patchwork)
source(here("c:/Users/nazar/Documents/Projects/MI_AGI/functions/oxy_demand_functions.R"))
set.seed(0904)

shore <- ne_download(scale = "medium", type = "land", category = "physical", returnclass = "sf")
mid_atlantic_bbox <- st_bbox(c(xmin = -77, xmax = -68, ymin = 34, ymax = 42), crs = st_crs(shore))
mid_atlantic_coast <- st_crop(shore, mid_atlantic_bbox)

theme_custom <- function(){
 theme_minimal() + 
 theme(axis.text = element_text(size = 14, color = "black"), 
        axis.title = element_text(size = 16, color = "black"), 
        legend.text = element_text(size = 14, color = "black"), 
        legend.title = element_text(size = 16, color = "black"), 
       plot.title = element_text(size = 16, color = "black"))
}

```

## Simulate enviro data

```{r}
#| warning: false
#| label: simu

enviro_sim <- expand.grid(DO_atm = seq(from = 0.05, to = 0.21, by = 0.05), 
                          temp = seq(from = 0, to = 35, by = 2))

DO_thresh <- quantile(enviro_sim$DO_atm)[1]

```

## Calculate MI and AGI

::: panel-tabset
### Black sea bass

```{r}
#| warning: false
#| label: calc bass

### MI ####
enviro_bass <- enviro_sim %>% mutate(DO_kpa = DO_atm*101.325)
enviro_bass$mi <- MI_calc(A0 = 0.00040728, Bn = 0.01, DO_kPa = enviro_bass$DO_kpa, E0 = 0.27, kB = 0.00008617333262, T_C = enviro_bass$temp)
hist(enviro_bass$mi)

### AGI ####
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 498.95, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8)
enviro_bass$agi <- enviro_bass$DO_atm/enviro_bass$agi_o2_demand
hist(enviro_bass$agi, breaks = 2)

```

### Atlantic cod

Used same simulated data for both species. Though normative temperatures would be much lower for cod than bass. Weight is average reported online.

```{r}
#| warning: false
#| label: calc cod

### MI ####
enviro_cod <- enviro_sim %>% mutate(DO_kpa = DO_atm*101.325)
enviro_cod$mi <- MI_calc(A0 = 0.000000668, Bn = 0.01, DO_kPa = enviro_cod$DO_kpa, E0 = 0.42, kB = 0.00008617333262, T_C = enviro_cod$temp)
hist(enviro_cod$mi)

### AGI ####
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 39916.1, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 148, LwA = 0.005, LwB = 3.185)
enviro_cod$agi <- enviro_cod$DO_atm/enviro_cod$agi_o2_demand
hist(enviro_cod$agi, breaks = 2)

```
:::

## Size explore (AGI oxygen demand, units: atm)

**Linf (according to von Bertalanffy growth theory)** = NOT the maximum length of the animal. Instead, it is the length a species would reach if it continued to grow indefinitely. Horizontal asymptote of the asymptotic growth curve.

**Winf (according to Fishbase)** = A parameter of the von Bertalanffy Growth Function (VBGF), expressing the mean weight the fish of a given stock would reach if they were to grow for an infinitely long period; also: the weight corresponding to Linf.

::: panel-tabset
### Black sea bass weight

Min and max weights from the MI study

```{r}
#| warning: false
#| label: W bass

#max weight for species
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 700.4, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8)
hist(enviro_bass$agi_o2_demand, breaks = 3)

#min weight for species
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 193.7, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8)
hist(enviro_bass$agi_o2_demand, breaks = 3)

```

### Atlantic cod weight

Min and max weights used here are just for **juveniles** included in MI study.

```{r}
#| warning: false
#| label: W cod

#max weight for species
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 473, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 148, LwA = 0.005, LwB = 3.185)
hist(enviro_cod$agi_o2_demand, breaks = 4)

#min weight for species
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 79, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 148, LwA = 0.005, LwB = 3.185)
hist(enviro_cod$agi_o2_demand, breaks = 4)

```

### Black sea bass length (Winf via Linf)

Min and max TL from MI study. Weights are average from MI study (Slessinger et al., 2019; 329.9 g)

```{r}
#| warning: false
#| label: Winf bass

#max length for species -- max weight included in MI study
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 329.9, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 39.8, LwA = 0.02661, LwB = 2.8)
hist(enviro_bass$agi_o2_demand, breaks = 3)

#min length for species -- min weight included in MI study
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 329.9, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 22.1, LwA = 0.02661, LwB = 2.8)
hist(enviro_bass$agi_o2_demand, breaks = 3)

```

### Atlantic cod length (Winf via Linf)

Min and max TLs used here are just for juveniles included in MI study. Weights are average from MI study from SMR results at 10C.

```{r}
#| warning: false
#| label: Winf cod

#max length for species -- max weight included in MI study
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 157.7, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 39, LwA = 0.005, LwB = 3.185)
hist(enviro_cod$agi_o2_demand, breaks = 4)

#min length for species -- max weight included in MI study
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 157.7, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 21, LwA = 0.005, LwB = 3.185)
hist(enviro_cod$agi_o2_demand, breaks = 4)

```
:::

```{r}
#| warning: false
#| label: reset index calculations
#| include: false

### MI ####
enviro_bass <- enviro_sim %>% mutate(DO_kpa = DO_atm*101.325)
enviro_bass$mi <- MI_calc(A0 = 0.00040728, Bn = 0.01, DO_kPa = enviro_bass$DO_kpa, E0 = 0.27, kB = 0.00008617333262, T_C = enviro_bass$temp)
hist(enviro_bass$mi)

### AGI ####
enviro_bass$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 498.95, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8)
enviro_bass$agi <- enviro_bass$DO_atm/enviro_bass$agi_o2_demand
hist(enviro_bass$agi, breaks = 2)

#| warning: false
#| label: calc cod

### MI ####
enviro_cod <- enviro_sim %>% mutate(DO_kpa = DO_atm*101.325)
enviro_cod$mi <- MI_calc(A0 = 0.000000668, Bn = 0.01, DO_kPa = enviro_cod$DO_kpa, E0 = 0.42, kB = 0.00008617333262, T_C = enviro_cod$temp)
hist(enviro_cod$mi)

### AGI ####
enviro_cod$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 39916.1, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, 
                                      Linf = 148, LwA = 0.005, LwB = 3.185)
enviro_cod$agi <- enviro_cod$DO_atm/enviro_cod$agi_o2_demand
hist(enviro_cod$agi, breaks = 2)
```

## Temperature sensitivity analysis

Just performed for overall AGI values. Can follow up by focusing on how variations in the numerator or denominator change the AGI output.

::: panel-tabset
### Black sea bass

Tested how AGI calculations changed with a range of Tpref values. Tested a series of different temperatures within range of those where empirical MI data is available (12 - 30 C).

```{r}
#| warning: false
#| label: temp bass

Tpref_vect <- seq(12, 30, by = 3)

hist_list = list()
for(i in 1:length(Tpref_vect)){
  Tpref_temp = Tpref_vect[i]
  
  agi_o2_demand <- OxyDemand(Tpref = Tpref_temp, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 498.95, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, Linf = 34.1, LwA = 0.02661, LwB = 2.8)
  
  agi <- enviro_bass$DO_atm/agi_o2_demand
  
  hist_list[[i]] <- hist(agi, plot = FALSE, breaks = 2)
}

par(mfrow = c(2, 4))  # Set plotting area to 2 rows x 3 columns

for (i in seq_along(hist_list)) {
  plot(hist_list[[i]], main = paste("Histogram of Tpref", Tpref_vect[i], "째C"))
}

```

### Atlantic cod

Tested how AGI calculations changed with a range of Tpref values. Tested a series of different temperatures within range of those where empirical MI data is available (5 - 15 C).

```{r}
#| warning: false
#| label: temp cod

Tpref_vect <- seq(5, 15, by = 3)

hist_list = list()
for(i in 1:length(Tpref_vect)){
  Tpref_temp = Tpref_vect[i]
  
  agi_o2_demand <- OxyDemand(Tpref = Tpref_temp, PO2_thresh = DO_thresh, T_C = enviro_cod$temp, W = 39916.1, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, Linf = 148, LwA = 0.005, LwB = 3.185)
  agi <- enviro_bass$DO_atm/agi_o2_demand
  
  hist_list[[i]] <- hist(agi, plot = FALSE, breaks = 2)
}

par(mfrow = c(2, 2))  # Set plotting area to 2 rows x 3 columns

for (i in seq_along(hist_list)) {
  plot(hist_list[[i]], main = paste("Histogram of Tpref", Tpref_vect[i], "째C"))
}

```
:::

## Calculated metabolic demand (AGI denominator) vs. empirical

::: panel-tabset
### Black sea bass

Empirical data taken from target temperature binned averages from Slessinger et al., 2019. Sexes were mixed to calculate temperature specific averages. RMR are reported as mg O2/hr/kg. AGI-MR values are in atm.

```{r}
#| warning: false
#| label: met bass
par(mfrow = c(1,1))

emp_bass_test <- data.frame(temp = as.numeric(c(12, 17, 22, 24, 27)), 
                           RMR = as.numeric(c(47.68, 69.28, 94.42, 117.93, 142.5))) 

emp_bass_test$agi_o2_demand <- OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = emp_bass_test$temp, W = 498.95, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8)

ggplot(emp_bass_test, aes(x = RMR, y = agi_o2_demand, fill = temp)) +
  geom_smooth(method = "lm", linetype = "dashed", color = "gray40") +  # 1:1 line
  geom_point(shape = 21, size = 4, color = "black") +  
  scale_fill_gradientn(colors = wes_palette("Zissou1", 100, type = "continuous")) +
  theme_minimal() +
  labs(
    x = "RMR",
    y = "AGI oxygen demand",
    fill = "Temperature (째C)"
  )

bass_mod <- lm(agi_o2_demand ~ RMR, emp_bass_test)
summary(bass_mod) #R2 = 0.9605

```

### Atlantic cod

Empirical data taken from target temperature binned averages from Schurmann and Steffensen 1997. Values were pulled from table 1 of the paper. RMR are reported as mg O2/hr/kg. AGI-MR values are in atm.

```{r}
#| warning: false
#| label: met cod

emp_cod_test <- data.frame(temp = as.numeric(c(5, 10, 15)), 
                           SMR = as.numeric(c(35.5, 57, 78.2))) 

emp_cod_test$agi_o2_demand <- OxyDemand(Tpref = 12, PO2_thresh = DO_thresh, T_C = emp_cod_test$temp, W = 39916.1, d = 0.700, K = 0.121, j2 = 8, j1 = 4.5, Linf = 148, LwA = 0.005, LwB = 3.185)

ggplot(emp_cod_test, aes(x = SMR, y = agi_o2_demand, fill = temp)) +
  geom_smooth(method = "lm", linetype = "dashed", color = "gray40") +  # 1:1 line
  geom_point(shape = 21, size = 4, color = "black") +  
  scale_fill_gradientn(colors = wes_palette("Zissou1", 100, type = "continuous")) +
  theme_minimal() +
  labs(
    x = "SMR",
    y = "AGI oxygen demand",
    fill = "Temperature (째C)"
  )

cod_mod <- lm(agi_o2_demand ~ SMR, emp_cod_test)
summary(cod_mod) #R2 = 1

```
:::

## AGI & MI tile plots

Rounded DO and temperature data to whole numbers for figures and binned them by every 3 values to reduce resolution (and empty spaces) of tile plots.

::: panel-tabset
### Black sea bass

```{r}
#| warning: false
#| label: tile bass
#| fig-width: 15
#| fig-height: 7

enviro_bass <- enviro_bass %>% mutate(DO_whole = round(DO_kpa), temp_whole = round(temp))
#enviro_bass$temp_bin <- cut(enviro_bass$temp_whole, breaks = 12, labels = seq(from = 0, to = 35, by = 3))
#enviro_bass$DO_bin <- cut(enviro_bass$DO_whole, breaks = 6, labels = seq(from = 5, to = 21, by = 3))

#mi plot
mi_tile <- ggplot(enviro_bass, aes(x = as.factor(temp_whole), y = as.factor(DO_whole), fill = mi)) +
  geom_tile(color = "grey60") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

#agi
agi_tile <- ggplot(enviro_bass, aes(x = as.factor(temp_whole), y = as.factor(DO_whole), fill = agi)) +
  geom_tile(color = "grey60") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

ggpubr::ggarrange(mi_tile, agi_tile)

```

### Atlantic cod

```{r}
#| warning: false
#| label: tile cod
#| fig-width: 15
#| fig-height: 7

enviro_cod <- enviro_cod %>% mutate(DO_whole = round(DO_kpa), temp_whole = round(temp))
#enviro_cod$temp_whole <- cut(enviro_cod$temp_whole, breaks = 12, labels = seq(from = 0, to = 35, by = 3))
#enviro_cod$DO_whole <- cut(enviro_cod$DO_whole, breaks = 6, labels = seq(from = 5, to = 21, by = 3))


#mi plot
mi_tile <- ggplot(enviro_cod, aes(x = as.factor(temp_whole), y = as.factor(DO_whole), fill = mi)) +
  geom_tile(color = "grey60") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

#agi
agi_tile <- ggplot(enviro_cod, aes(x = as.factor(temp_whole), y = as.factor(DO_whole), fill = agi)) +
  geom_tile(color = "grey60") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

ggpubr::ggarrange(mi_tile, agi_tile)

```

### MI crit

Comparing MIcrit values as reported in Slessinger et al., 2024 reported for stocks along the NE shelf to scaled MIcrit values used by Deutsch et al., 2020.

```{r}
#| warning: false
#| label: tile mi crit
#| fig-width: 15
#| fig-height: 7

#bass - ES
mi_bass_1_es <- ggplot(enviro_bass, aes(x = temp_whole, y = DO_whole, fill = mi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = filter(enviro_bass, mi < 3.27),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Black sea bass, MIcrit reported by Slessinger et al., 2024") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom() 

#bass - CD
mi_bass_1_cd <- ggplot(enviro_bass, aes(x = temp_whole, y = DO_whole, fill = mi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = filter(enviro_bass, mi < 3.28), #range was 3.27-3.29 so I selected middle value
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Black sea bass, MIcrit reported by Deutsch et al., 2020") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom() 

#cod - ES
mi_cod_1_es <- ggplot(enviro_cod, aes(x = temp_whole, y = DO_whole, fill = mi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = filter(enviro_cod, mi < 2.8),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Atlantic cod, MIcrit reported by Slessinger et al., 2024") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

#cod - CD
mi_cod_1_cd <- ggplot(enviro_cod, aes(x = temp_whole, y = DO_whole, fill = mi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = filter(enviro_cod, mi < 2.4),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Atlantic cod, MIcrit reported by Deutsch et al., 2020") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

ggpubr::ggarrange(mi_bass_1_es, mi_bass_1_cd)
ggpubr::ggarrange(mi_cod_1_es, mi_cod_1_cd)

```

### AGI crit

```{r}
#| warning: false
#| label: tile agi crit
#| fig-width: 15
#| fig-height: 7

#bass
agi_bass_1 <- ggplot(enviro_bass, aes(x = temp_whole, y = DO_whole, fill = agi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = subset(enviro_bass, agi < quantile(agi, 0.10)),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Black sea bass") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom() 

#cod
agi_cod_1 <- ggplot(enviro_cod, aes(x = temp_whole, y = DO_whole, fill = agi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = subset(enviro_cod, agi < quantile(agi, 0.10)),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Atlantic cod") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom()

ggpubr::ggarrange(agi_bass_1, agi_cod_1)

```

### AGI bass sizes

```{r}
#| warning: false
#| label: tile agi size bass
#| fig-width: 15
#| fig-height: 7

enviro_bass_size <- enviro_bass %>%
  mutate(bass_lg_demand = OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 700.4, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8), 
         bass_lg_agi = DO_atm/bass_lg_demand, 
         bass_sm_demand = OxyDemand(Tpref = 22, PO2_thresh = DO_thresh, T_C = enviro_bass$temp, W = 193.7, d = 0.700, K = 0.231, j2 = 8, j1 = 4.5, 
                                      Linf = 34.1, LwA = 0.02661, LwB = 2.8), 
         bass_sm_agi = DO_atm/bass_sm_demand)


#bass large
agi_bass_lg <- ggplot(enviro_bass_size, aes(x = temp_whole, y = DO_whole, fill = bass_lg_agi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = subset(enviro_bass_size, agi < quantile(bass_lg_agi, 0.10)),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Large black sea bass (700.4 g)") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom() 

#bass small
agi_bass_sm <- ggplot(enviro_bass_size, aes(x = temp_whole, y = DO_whole, fill = bass_sm_agi)) +
  geom_tile(color = "grey60") + 
  geom_rect(data = subset(enviro_bass_size, agi < quantile(bass_sm_agi, 0.10)),
            aes(xmin = as.numeric(temp_whole) - 1, 
                xmax = as.numeric(temp_whole) + 1,
                ymin = as.numeric(DO_whole) - 2.5, 
                ymax = as.numeric(DO_whole) + 2.5), 
            fill = NA, 
            color = "#F0941F", 
            linewidth = 2,
            inherit.aes = FALSE) +
  ggtitle("Small black sea bass (193.7 g)") + 
  ylab("Dissolved oxygen (kPa)") + 
  xlab("Temperature (C)") + 
  theme_custom() 

ggpubr::ggarrange(agi_bass_lg, agi_bass_sm)

```
:::

## AGI \~ temperature scatter

Kept DO at normoxia (0.21 atm) when calculating the AGI. **NOTE** something strange happening with y-axis when rendering html document.

```{r}
#| warning: false
#| label: agi, temp, scatter
#| fig-width: 10
#| fig-height: 5

#bass
enviro_bass$agi_normoxia <- 0.21/enviro_bass$agi_o2_demand

bass_norm <- ggplot(enviro_bass, aes(temp, agi_normoxia)) + 
  geom_point(size = 2, color = "black") + 
  xlab("Temperature (C)") + 
  ylab("AGI @ normoxia") + 
  #coord_cartesian(ylim = c(5.4815, 5.490)) +
  ggtitle("Bass") + 
  theme_custom()

#cod
enviro_cod$agi_normoxia <- 0.21/enviro_cod$agi_o2_demand

cod_norm <- ggplot(enviro_cod, aes(temp, agi_normoxia)) + 
  geom_point(size = 2, color = "black") + 
  xlab("Temperature (C)") + 
  ylab("AGI @ normoxia") + 
  ggtitle("Cod") +
  theme_custom()

bass_norm | cod_norm

```

## AGI \~ MI

```{r}
#| warning: false
#| label: agi, mi, scatter
#| fig-width: 10
#| fig-height: 5

#bass
bass_mi_agi <- ggplot(enviro_bass, aes(mi, agi)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 2, color = "black") + 
  xlab("MI") + 
  ylab("AGI") + 
  coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Bass") + 
  theme_custom()

#cod
cod_mi_agi <- ggplot(enviro_cod, aes(mi, agi)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 2, color = "black") + 
  xlab("MI") + 
  ylab("AGI") +  
  coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Cod") +
  theme_custom() 

bass_mi_agi | cod_mi_agi

cod_mod <- lm(agi ~ mi, data = enviro_cod); summary(cod_mod)
bass_mod <- lm(agi ~ mi, data = enviro_bass); summary(bass_mod)


```

## AGI/MI \~ temp.

::: panel-tabset
## Bass

```{r}
#| warning: false
#| label: bass, agi, mi, temp, scatter
#| fig-width: 10
#| fig-height: 5

#bass, mi
bass_mi_temp <- ggplot(enviro_bass, aes(temp, mi, fill = DO_atm)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 3, color = "black", shape = 21) + 
  xlab("Temperature (C)") + 
  ylab("MI") + 
  #coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Bass, MI") + 
  theme_custom()

bass_mod_mi_temp <- lm(mi ~ temp, data = enviro_bass); summary(bass_mod_mi_temp)

#bass, agi
bass_agi_temp <- ggplot(enviro_bass, aes(temp, agi, fill = DO_atm)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 3, color = "black", shape = 21) + 
  xlab("Temperature (C)") + 
  ylab("AGI") + 
  #coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Bass, AGI") + 
  theme_custom()

bass_mod_agi_temp <- lm(agi ~ temp, data = enviro_bass); summary(bass_mod_agi_temp)

bass_mi_temp | bass_agi_temp
```

## Cod

```{r}
#| warning: false
#| label: cod, agi, mi, temp, scatter
#| fig-width: 10
#| fig-height: 5

#cod, mi
cod_mi_temp <- ggplot(enviro_cod, aes(temp, mi, fill = DO_atm)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 3, color = "black", shape = 21) + 
  xlab("Temperature (C)") + 
  ylab("MI") + 
  #coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Cod, MI") + 
  theme_custom()

cod_mod_mi_temp <- lm(mi ~ temp, data = enviro_cod); summary(cod_mod_mi_temp)

#cod, agi
cod_agi_temp <- ggplot(enviro_cod, aes(temp, agi, fill = DO_atm)) + 
  stat_smooth(method = "lm", col = "steelblue4") +
  geom_point(size = 3, color = "black", shape = 21) + 
  xlab("Temperature (C)") + 
  ylab("AGI") + 
  #coord_cartesian(ylim = c(1, 4.2)) +
  ggtitle("Cod, AGI") + 
  theme_custom()

cod_mod_agi_temp <- lm(agi ~ temp, data = enviro_cod); summary(cod_mod_agi_temp)

cod_mi_temp | cod_agi_temp
```
:::